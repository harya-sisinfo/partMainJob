<!-- patTemplate:tmpl name="content" -->
<h1>Usulan Barang</h1>
<br/>
<!-- patTemplate:tmpl name="warning_box" visibility="hidden" -->
<div class="{CLASS_PESAN}">
   {ISI_PESAN}
</div>
<br/>
<!-- /patTemplate:tmpl -->
<div class="pageBar">
   <div class="toolbar">
      <a class="xhr dest_subcontent-element" href="{URL_BACK}" title="Lihat Daftar Usulan" ><img src="images/button-bac.gif" alt="">Lihat Daftar Usulan</a>
   </div>
</div>
<form method="POST" action="{URL_ACTION}" id="frmInput" class="xhr_form std_form" enctype='multipart/form-data'>
   <table class="table-edit" width="100%"><tbody id="formInputContainer">
      <tr class="subhead">
         <th colspan="2">Tambah Usulan</th>
      </tr>
      <tr>
         <td><!-- patTemplate:gtfwgetconfig config="language" name="tanggal_usulan" / --> *</td>
         <td>
            <span id='tglUsulan1'>
               <input type='text' name='tglUsulan1Display' id='tglUsulan1Display' value='{TGLUSULAN1DISPLAY}' readonly />
               <input type='hidden' name='usulanBrgTglUsulan' id='tglUsulan1Input' value='{USULANBRGTGLUSULAN}'/>
               <input type='button' value='...' id='tglUsulan1Button' title='Klik untuk memilih tanggal!'/>
            </span>
         </td>
      </tr>
      <tr>
			<td>Periode *</td>
         <td>
				<!-- patTemplate:gtfwrendermodule module="combobox" submodule="combobox" action="view" name="periode"  / -->  
         </td>
      </tr>
      <tr>
         <td><!-- patTemplate:gtfwgetconfig config="language" name="no_usulan" / --> *</td>
         <td>
            <input type="text" name="usulanBrgNoUsulan" value="{USULANBRGNOUSULAN}" size="30"/>
            <input type='text' style='display: none' class='gvFloat' id='fakeInput'>
         </td>
      </tr>
		<tr>
			<td><!-- patTemplate:gtfwgetconfig config="language" name="rencana_pengadaan" / --> *</td>
         <td>
				<input type='text' name='usulanBrgMAKNama' value='{USULANBRGMAKNAMA}' id='POP_UP_MAK_NAMA' size="60" readonly/>
            <input type='button' value='...' onclick='javascript: showPopup("{URL_RENCANA_PENGADAAN}", "", 900, 550);'/>
            <input type='text' name='usulanBrgMAK' value='{USULANBRGMAK}' id='POP_UP_MAK_KODE' readonly/>
            <input type='hidden' name='usulanBrgMAKNominal' value='{USULANBRGMAKNOMINAL}' id='POP_UP_MAK_NOMINAL'/>
            <input type='hidden' name='usulanBrgMAKId' onkeyup="setRencana(this.value)" value='{USULANBRGMAKID}' id='POP_UP_MAK_THANGGARID'/>
            
         </td>
      </tr>
      <tr>
         <td colspan="2">
         	Detil Pengadaan
         	<div id="rencana_pengadaan_barang">
				<div style="height:200px;overflow:auto;">
         		<table width="100%" class="table-common">
               	<thead>
               	   <tr>
               	      <th>Kode</th>
               	      <th>Nama</th>
               	      <th>Nominal Usulan (Rp.)</th>
               	      <th>Nominal Setuju (Rp.)</th>
               	      <th>Satuan Usulan</th>
               	      <th>Satuan Setuju</th>
               	      <th>Jumlah Usulan (Rp.)</th>
               	      <th>Jumlah Setuju (Rp.)</th>
								<th>Status Approval</th>
								<th>Keterangan</th>
               	   </tr>
               	</thead>
               	<tbody>
                  	<tr>
                  	  <td colspan="10" align="center">
                  	  	<em>-- <!-- patTemplate:gtfwgetconfig config="language" name="data_kosong" / --> --</em>
                  	  </td>
                  	</tr>
               	</tbody>
             	</table>
       		</div>
         </td>
      </tr>
      <tr>
         <td>
         	<!-- patTemplate:gtfwgetconfig config="language" name="unit" / --> *
         </td>
         <td>
				<input type='hidden' name='usulanBrgUnitId' value='{USULANBRGUNITID}' id='pop_up_unit_pj_id' size="40"/>
            <input type='text' name='usulanBrgUnitNama' value='{USULANBRGUNITNAMA}' id='pop_up_unit_pj_name' size="40" readonly>
            <input type='button' value='...' onclick='javascript: showPopup("{URL_POPUP_UNIT}", "", 600, 500);'/> 
         </td>
      </tr>
		<tr>
         <td>
            <!-- patTemplate:gtfwgetconfig config="language" name="detail_barang" / --> *
         </td>
         <td>
            <input type="button" value=" Tambah " id="detButtonSubmit" onClick="javascript: showPopup('{URL_POPUP_DHS_BARANG_JASA}', '', 800, 500);" />
            <!--
            <input type="button" value=" Tambah " id="detButtonSubmit" onClick="javascript: document.getElementById('detBarangContainer').addItem('','','','','','','',0,0)" />
            -->
         </td>
      </tr>
      <tr>
         <td colspan="2">
            <table class="table-common" align="center" width="100%">
               <thead id="detBarangContainer">
                  <tr>
                     <th align="center">Akun Belanja</th>
                     <th align="center">Jenis Pengadaan</th>
                     <th align="center">Jenis Barang</th>
                     <th align="center"><!-- patTemplate:gtfwgetconfig config="language" name="nama_barang" / --></th>
                     <th align="center"><!-- patTemplate:gtfwgetconfig config="language" name="spesifikasi" / --></th>
                     <th align="center">File</th>
                     <th align="center"><!-- patTemplate:gtfwgetconfig config="language" name="jumlah_usulan" / --></th>
                     <th align="center">Satuan</th>
                     <th align="center">Harga Satuan (Rp)</th>
                     <th align="center">Total (Rp)</th>
                     <th align="center"><!-- patTemplate:gtfwgetconfig config="language" name="aksi" / --></th>
                  </tr>
               </thead>
               <tbody id="rincianKosong">
                  <tr>
                     <td colspan="11" align='center'>
                        Belum ada data, klik [Tambah] untuk memilih!
                     </td>
                  </tr>
               </tbody>
               
            </table>
         </td>
      </tr>
      <tr class="buttons">
         <th>&nbsp;</th>
         <td>
            <input type="submit" name="btnsimpan" id="btnSimpan" value=" Simpan " class="buttonSubmit"/>
            <a class="xhr dest_subcontent-element" href="{URL_BACK}" >
            	<input  type="button"  name="btnbalik" value=" Batal " class="buttonSubmit"/>
            </a>
         </td>
      </tr>
   </tbody>
 </table>
</form>

<br/>
<div class="petunjuk-area">
   <h4><!-- patTemplate:gtfwgetconfig config="language" name="petunjuk" / -->:</h4>
   <ul>
      <li><!-- patTemplate:gtfwgetconfig config="language" name="info_wajib_diisi" / -->. </li>
   </ul>
</div>

<script language="javascript" type="text/javascript">
// loadm data deto; pengadaan
if (document.getElementById('POP_UP_MAK_THANGGARID').value){      
   	GtfwAjax.replaceContentWithUrl('rencana_pengadaan_barang', '<!-- patTemplate:gtfwgeturl module="mr_usulan_barang" sub="tableRencanaPengeluaran" action="view" type="html" htmlentities="no" / -->&ascomponent=1&dataId='+document.getElementById('POP_UP_MAK_THANGGARID').value);
}

// seting up DateChooser

DateChooser.nDateChooserID = 0;
document.getElementById('tglUsulan1').date = new DateChooser();
document.getElementById('tglUsulan1').date.setCloseTime(200);
document.getElementById('tglUsulan1').date.setUpdateField({'tglUsulan1Display':'d F Y','tglUsulan1Input':'U'});
document.getElementById('tglUsulan1Button').onclick = document.getElementById('tglUsulan1').date.display;
document.getElementById('tglUsulan1').date.setLatestDate(new Date);
if (!isNaN(parseInt(document.getElementById('tglUsulan1Input').value)))
document.getElementById('tglUsulan1').date.setSelectedDate(new Date(document.getElementById('tglUsulan1Input').value * 1000));

document.getElementById('detBarangContainer').addItem = function (brgId, brgKodeAkun, brgJenisPengadaan, brgJenisBarang, usulanBrgDetBrgNama, usulanBrgDetBrgSpesifikasi, usulanBrgDetBrgSatuan, usulanBrgNilaiHps, jmlDO)
{
   nomor = this.getElementsByTagName('tr').length;
   var tr = document.createElement('tr');
   var id = 'item_' + nomor;
   
   tr.setAttribute("id", id);
   
   if(document.getElementById('combo_kode_akun')){
      eval('combo_akun = ' + document.getElementById('combo_kode_akun').value+';');
   }
   
   combo_barang = {JSON_JENIS_BARANG};

   combo_jenis = {JSON_JENIS_PENGADAAN};

   //-- kode akun
   var tdKode = document.createElement('td');
   var kodeSelect = document.createElement('select');
   kodeSelect.setAttribute('name', 'detail_barang[' + id +'][usulanBrgDetKodeAkun]');
   kodeSelect.options[0] = new Option('--PILIH--', 0);
   for (i = 0; i < combo_akun.length; i++) kodeSelect.options[i+1] = new Option(combo_akun[i].name, combo_akun[i].id, (brgKodeAkun == combo_akun[i].id));
   tdKode.appendChild(kodeSelect);

   //-- pengadaan
   var tdPengadaan = document.createElement('td');
   var pengadaanSelect = document.createElement('select');
   pengadaanSelect.setAttribute('name', 'detail_barang[' + id +'][usulanBrgDetJenisPengadaanId]');
   pengadaanSelect.options[0] = new Option('--PILIH--', 0);
   for (i = 0; i < combo_jenis.length; i++) pengadaanSelect.options[i+1] = new Option(combo_jenis[i].name, combo_jenis[i].id, (brgJenisPengadaan == combo_jenis[i].id));
   tdPengadaan.appendChild(pengadaanSelect);

   //-- barang
   var tdBarang = document.createElement('td');
   var barangSelect = document.createElement('select');
   barangSelect.setAttribute('name', 'detail_barang[' + id +'][usulanBrgDetBrgKelompokId]');
   barangSelect.options[0] = new Option('--PILIH--', 0);
   for (i = 0; i < combo_barang.length; i++) barangSelect.options[i+1] = new Option(combo_barang[i].name, combo_barang[i].id, (brgJenisBarang == combo_barang[i].id));
   tdBarang.appendChild(barangSelect);

   //-- nama barang
   var tdNama = document.createElement('td');
   tdNama.innerHTML = usulanBrgDetBrgNama + "<input type='hidden' name='detail_barang[" + id + "][usulanBrgDetBrgId]' value='" + brgId + "'>";

   //- spesifikasi
   var tdSpek = document.createElement('td');
   tdSpek.innerHTML = "<textarea name='detail_barang[" + id + "][usulanBrgDetBrgSpesifikasi]'>"+usulanBrgDetBrgSpesifikasi+"</textarea>";

   //-- upload file arsip
   var tdUpload = document.createElement('td');
   tdUpload.innerHTML = "<input type='file' size='10' id='fileArsip[]' name='fileArsip[]'><input  type='button' onclick=\"\" value='Reset' style='display:none' />";

    //-- jumlah usulan
   var tdjumlah = document.createElement('td');
   tdjumlah.innerHTML = "<input size='4' style='text-align:right' type='text' name='detail_barang[" + id + "][usulanBrgDetJml]' id='usulanBrgDetJml["+ nomor +"]' value='"+jmlDO+"'><input type='hidden' name='counter' value='"+nomor+"'>";

   //-- satuan barang
   var tdSatuan = document.createElement('td');
   tdSatuan.innerHTML = "<input type='text' size='5' name='detail_barang[" + id + "][usulanBrgDetBrgSatuan]' value='" + usulanBrgDetBrgSatuan + "'>";

   //-- harga satuan
   var tdHps = document.createElement('td');
   tdHps.innerHTML = "<input type='text' size='8' style='text-align:right' id='usulanBrgNilaiHps["+nomor+"]' name='detail_barang[" + id + "][usulanBrgNilaiHps]' value='" + usulanBrgNilaiHps + "'>";
   
   //-- Subtotal
   var tdSubTotal = document.createElement('td');
   tdSubTotal.setAttribute("align", "right");
   tdSubTotal.setAttribute("id", id + "-total2");
   tdSubTotal.innerHTML = fakeInput.gvExcelLikeFormat(jmlDO * usulanBrgNilaiHps) + "<input type='hidden' size='10px' style='text-align:right' name='detail_barang[" + id + "][subTotal]' id ='subtotals["+nomor+"]' class='subtotals' value='" + (jmlDO*usulanBrgNilaiHps) + "' readonly>";

   var tdDelete = document.createElement('td');
   tdDelete.setAttribute("align", "center");
   tdDelete.setAttribute("width", "32px");
   tdDelete.setAttribute("class", "links");
   tdDelete.innerHTML = "<a onClick=\"document.getElementById('detBarangContainer').deleteItem('"+ id +"');\" title='Hapus'><img src=\"images/button-delete.gif\" alt=\"Hapus\"></a>";

   tr.appendChild(tdKode);
   tr.appendChild(tdPengadaan);
   tr.appendChild(tdBarang);
   tr.appendChild(tdNama);
   tr.appendChild(tdSpek);
   tr.appendChild(tdUpload);
   tr.appendChild(tdjumlah);
   tr.appendChild(tdSatuan);
   tr.appendChild(tdHps);
   tr.appendChild(tdSubTotal);
   tr.appendChild(tdDelete);
   this.style.display = '';
   this.appendChild(tr);

   document.getElementById('rinciankosong').style.display = 'none';
   return true;

}
document.getElementById('detBarangContainer').deleteItem = function (id)
{
   this.removeChild(document.getElementById(id));
   Obj = this.getElementsByTagName('tr');
   if (Obj.length == 1) {
      this.style.display = '';
      document.getElementById('rinciankosong').style.display = '';
/*
      document.getElementById('penjualan_langsung_subtotal').value = hitungTotal();
      document.getElementById('total_html').innerHTML = hitungTotal();  
      document.getElementById('total_value').value = hitungTotal();
      document.getElementById('penjualan_langsung_kembali_html').value = hitungTotal();
      document.getElementById('penjualan_langsung_kembali').value = hitungTotal();
*/
   }else for (i = 1; i < Obj.length; i++){
      Obj[i].firstChild.innerHTML = i;
 //     SUBTOTAL=hitungTotal();
   }
}

function hitungTotal(){
   var totalDetil = 0;
   var hasilHitung = 0;
   var total_akhir = 0;
   var sisa = 0;
   
   var bykTr = document.getElementsByName('counter').length;
   var potongan = parseInt(document.getElementById('penjualan_langsung_potongan').value);
   var tambahan = parseInt(document.getElementById('penjualan_langsung_tambahan').value);
   var bayar = parseInt(document.getElementById('penjualan_langsung_bayar').value);

   for(var i=0; i<bykTr; i++){
      jumlah = $('.jumlah')[i].value;
      harga = $('.harga')[i].value;
                  
      hasilHitung = jumlah * harga;

      $('.subtotals')[i].value = hasilHitung;   
   }  
      
   for(var i=0; i<bykTr; i++){
      detAsetSubTotal=$('.subtotals')[i].value;
      totalDetil+=parseInt(detAsetSubTotal);
   }
   
   document.getElementById('penjualan_langsung_subtotal').value = totalDetil;  

   if(isNaN(tambahan)){
      tambahan = 0;
   }
   if(isNaN(potongan)){
      potongan = 0;
   }
   if(isNaN(bayar)){
      bayar = 0;
   }
   
   total_akhir = (totalDetil+tambahan)-potongan; 
   document.getElementById('total_html').innerHTML = formatCurrency(total_akhir);  
   document.getElementById('total_value').value = total_akhir;
   
   sisa = bayar-total_akhir;
   document.getElementById('penjualan_langsung_kembali_html').innerHTML = formatCurrency(sisa);
   document.getElementById('penjualan_langsung_kembali').value = sisa;
}

detailBarang = {JSON_DETAIL_BARANG};
for (id in detailBarang) document.getElementById('detBarangContainer').addItem(
   detailBarang[id].usulanBrgDetBrgId,
   detailBarang[id].usulanBrgDetKodeAkun,
   detailBarang[id].usulanBrgDetJenisPengadaanId,
   detailBarang[id].usulanBrgDetBrgKelompokId,
   detailBarang[id].usulanBrgDetBrgNama,
   detailBarang[id].usulanBrgDetBrgSpesifikasi,
   detailBarang[id].usulanBrgDetBrgSatuan,
   detailBarang[id].usulanBrgNilaiHps,
   detailBarang[id].usulanBrgDetJml
);

document.getElementById('frmInput').numberValidate = function (Obj)
{
   str = Obj.old;
   Obj.old = undefined;
   if (Obj.value == "" || parseInt(Obj.value) == Obj.value) return true;
   Obj.value = str;
   return false;
}

</script>
<!-- /patTemplate:tmpl -->
